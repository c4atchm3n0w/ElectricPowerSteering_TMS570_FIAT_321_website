---
title: StaMd_Integration_Manual
linkTitle: StaMd_Integration_Manual
weight: 4
---

<p><a href="#dependencies">1 Dependencies <span>2</span></a></p>
<p><a href="#swcs">1.1 SWCs <span>2</span></a></p>
<p><a href="#global-functionsnon-rte-to-be-provided-to-integration-project">1.2 Functions to be provided to Integration Project <span>2</span></a></p>
<p><a href="#configuration">2 Configuration <span>3</span></a></p>
<p><a href="#build-time-config">2.1 Build Time Config <span>3</span></a></p>
<p><a href="#configuration-files-to-be-provided-by-integration-project">2.2 Configuration Files to be provided by Integration Project <span>3</span></a></p>
<p><a href="#da-vinci-parameter-configuration-changes">2.2.1 Da Vinci Config generation <span>3</span></a></p>
<p><a href="#da-vinci-parameter-configuration-changes">2.2.2 Manual Configuration Changes <span>3</span></a></p>
<p><a href="#integration">3 Integration <span>4</span></a></p>
<p><a href="#required-global-data-inputs">3.1 Required Global Data Inputs <span>4</span></a></p>
<p><a href="#_Toc357692828">3.2 Optional Global Data Inputs <span>4</span></a></p>
<p><a href="#specific-include-path-present">3.3 Specific Include Path present <span>4</span></a></p>
<p><a href="#runnable-scheduling">4 Runnable Scheduling <span>5</span></a></p>
<p><a href="#memory-mapping">5 Memory Mapping <span>6</span></a></p>
<p><a href="#mapping">5.1 Mapping <span>6</span></a></p>
<p><a href="#usage">5.2 Usage <span>6</span></a></p>
<p><a href="#non-rte-nvm-blocks">5.3 NvM Blocks <span>6</span></a></p>
<p><a href="#compiler-settings">6 Compiler Settings <span>6</span></a></p>
<p><a href="#preprocessor-macro">6.1 Preprocessor MACRO <span>6</span></a></p>
<p><a href="#optimization-settings">6.2 Optimization Settings <span>6</span></a></p>
<p><a href="#revision-control-log">7 Revision Control Log <span>7</span></a></p>
<h1 id="dependencies">Dependencies</h1>
<h2 id="swcs">SWCs</h2>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 69%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Module</strong></th>
<th><strong>Required Feature</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>ECUStatup.c</strong></td>
<td><p>StaMd_Init0 needs to be called from EcuStartup_Init2 via a trusted wrapper after Nvm ‘read all’ is complete, by calling Call_StaMd_Init0.</p>
<p>ECUStartup needs to also include the Ap_StaMd.h header file.</p>
<p>The StaMd_Init0 is defined outside of the RTE and is responsible for updating Type H memory across applications at start up. StaMd_Init0 needs to be added to a non-trusted function list in a trusted application in the O.S.</p></td>
</tr>
<tr class="even">
<td><strong>NtWrap.c, .h, O.S changes</strong></td>
<td><p>Add trusted function call to NtWrap :</p>
<p>/* Trusted wrapper Function */</p>
<p>void TRUSTED_NtWrapS_StaMd_Init0</p>
<p>(TrustedFunctionIndexType FunctionIndex, TrustedFunctionParameterRefType FunctionParams)</p>
<p>{</p>
<p>StaMd_Init0();</p>
<p>}</p>
<p>…</p>
<p>void <mark>Call_StaMd_Init0</mark>(void)</p>
<p>{</p>
<p>(void) CallTrustedFunction</p>
<p>(NtWrapS_StaMd_Init0,</p>
<p>(TrustedFunctionParameterRefType)0);</p>
<p>}</p></td>
</tr>
<tr class="odd">
<td><strong>Optional NvM Fast Write implementation to meet program specific ECUReset or Programming session transition timing requirements.</strong></td>
<td><p>Whenever an ECU Reset (StaMd_SCom_EcuReset) or FlashBootloader/Programming session service request (StaMd_SCom_FBLTransitionReq ) the StaMd module is notified by the corresponding Scom functions, typically called directly from the diagnostic service handler. The system is then forced to the OFF state and an output flag, <strong>InitiatePwrDnFastWrite_Cnt_lgc</strong> is set to TRUE. This flag can be used to trigger a FAST NVM write as an option to meet ECU Rest and/or FlashBootloader/Programming session timing requirements.</p>
<p>The <strong>InitiatePwrDnNormalWrite_Cnt_lgc</strong> output flag will be set to TRUE in case of a normal transition to OFF.</p>
<p>The implementation of the “fast” NvM write is done by running the main functions responsible for handling the NvM processing continuously in a WHILE loop until all of NvM, including the closecheck flag used for NTC $BF, has been written. These main functions (NvM, Ea, NvMProxy etc…) are typically called from a SchM task. <strong><mark>Since the fast write occurs in a WHILE loop, it is important that the</mark></strong> <strong><mark>fast write is implemented in a low priority</mark></strong> <strong><mark>SchM task.</mark></strong> <strong><mark>Review the task priorities before implementation.</mark></strong></p>
<p>For example, see the Ford S550/P552 fast NvM write implementation below. This is in a priority 2 SchM task. The only other tasks with a lower priority are the Background task and a SchM init task:</p>
<p><strong>do</strong></p>
<p>{</p>
<p>GetResource(OsRes_MemStackTask);</p>
<p>Eep_30_At25128_MainFunction();</p>
<p>Ea_MainFunction();</p>
<p>NvMProxy_MainFunction();</p>
<p>NvM_MainFunction();</p>
<p>ReleaseResource(OsRes_MemStackTask);</p>
<p>}<strong>while</strong>(<mark>CDD_InitiatePwrDn<strong>FastWrite</strong>_Cnt_G_lgc</mark> == TRUE);</p>
<p>In the case of a FlashBootloader/Programming session service request (<strong>StaMd_SCom_FBLTransitionReq)</strong>, once the NvM write is complete the output flag, <strong>PwrDnFastWriteComplete_Cnt_lgc</strong>, will be set to TRUE (<strong>See the Data Dictionary</strong>). The PwrDn<strong>FastWriteComplete</strong> flag can be used as follows to complete a FlashBootloader/Programming session transition request:</p>
<p>if (ProgrammingSessionEntered_Cnt_M_lgc == TRUE)</p>
<p>{</p>
<p>if (<mark>CDD_PwrDn<strong>FastWriteComplete</strong>_Cnt_G_lgc</mark> == TRUE)</p>
<p>{</p>
<p>ProgrammingSessionEntered_Cnt_M_lgc = FALSE;</p>
<p>/* <strong>Jump to Bootloader</strong> */</p>
<p>Program Specific Vector to Bootloader</p>
<p>}</p>
<p>}</p>
<p>These status flags can be provided to complex device drivers, such as SchM, via CDD interface by creating the following global variables: <strong>CDD_PwrDnFastWriteComplete_Cnt_G_lgc</strong>, <strong>CDD_InitiatePwrDnFastWrite_Cnt_G_lgc, CDD_InitiatePwrDnNormalWrite_Cnt_G_lgc</strong></p>
<p><strong>NOTE:</strong> The StaMd_SCom_FBLTransitionReq should only be used to update NvM, if required, before transitioning to the bootloader in response to a diagnostic service request to transition to a flash programming session. Only use this Scom function as intended. Once this Scom function is called a reset or vector from the application is expected after the PwrDnFastWriteComplete flag has been set to true.</p></td>
</tr>
<tr class="even">
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Note : Referencing the external components should be avoided in most cases. Only in unavoidable circumstance external components should be refered. Developer should track the references.</p>
<h2 id="global-functionsnon-rte-to-be-provided-to-integration-project">Global Functions(Non RTE) to be provided to Integration Project</h2>
<p>extern FUNC(void, MCU_CODE) <strong>Mcu_PerformReset</strong>(void);</p>
<h1 id="configuration">Configuration</h1>
<h2 id="build-time-config">Build Time Config</h2>
<table style="width:100%;">
<colgroup>
<col style="width: 36%" />
<col style="width: 53%" />
<col style="width: 9%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Modules</strong></th>
<th><strong>Notes</strong></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>&lt;None&gt;</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="configuration-files-to-be-provided-by-integration-project">Configuration Files to be provided by Integration Project</h2>
<h2 class="unnumbered" id="section"></h2>
<p><strong>Ap_StaMd_Cfg.h</strong></p>
<h3 id="da-vinci-parameter-configuration-changes">Da Vinci Parameter Configuration Changes</h3>
<table>
<colgroup>
<col style="width: 44%" />
<col style="width: 43%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Parameter</strong></th>
<th><strong>Notes</strong></th>
<th><strong>SWC</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>TypeHDataSize</strong></td>
<td>Total size of all Type H data in bytes</td>
<td></td>
</tr>
<tr class="even">
<td><strong>StaMdCPEnable</strong></td>
<td>This container contains the configuration (parameters) for the StaMd Watchdog checkpoints.</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>StaMdTODType</strong></td>
<td><p>This container defines the configuration for the type of TOD implementation used:</p>
<p>TOD_2msToggle</p>
<p>TOD_SteadyState (*common setting)</p>
<p>TOD_None</p></td>
<td></td>
</tr>
<tr class="even">
<td><strong>StaMdNvMWriteAllAPI</strong></td>
<td>This container defines the API used for the NvM Write All function. (*common setting is <strong>NvMProxy_WriteAll</strong> if the NvM proxy is used).</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>StaMdNvMGetErrorStatusAPI</strong></td>
<td>This container defines the API used for the NvM Get Error Status function. (*common setting is <strong>NvMProxy_GetErrorStatus</strong> if the NvM proxy is used).</td>
<td></td>
</tr>
<tr class="even">
<td><strong>StaMdTrnsDiagMgrShtDwnTaskActivation</strong></td>
<td><p>This container defines the DiagMgr shutdown function. If StaMdCoreOsAppRef matches the application referenced for DiagMgrDemIfOsAppRef in DiagMgr then the generated output will be a client/server call and this field is ignored. If they do not match, then a task activation call is created and the task defined in this field is activated.</p>
<p><strong>NOTE:</strong> Typical setting is Task_TrnsB_9 for the application 9 transition function, from which the StaMd9_Trns_DemShutdown function is called in some programs.</p></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>GenerateExcludeOsAppRef</strong></td>
<td>This parameter defines the application(s) which do not require a States and Modes component.</td>
<td></td>
</tr>
<tr class="even">
<td><strong>StaMdCoreOsAppRef</strong></td>
<td>This parameter defines the application which contains the core States and Modes component.</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>StaMdsComOsAppRef</strong></td>
<td>This parameter defines the application which interfaces with the serial communications functions.</td>
<td></td>
</tr>
<tr class="even">
<td><strong>StaMdSysCovOsAppRef</strong></td>
<td>This parameter defines the application which performs the states and modes systematic coverage.</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="davinci-interrupt-configuration-changes">DaVinci Interrupt Configuration Changes</h3>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>ISR Name</strong></th>
<th><strong>VIM #</strong></th>
<th><strong>Priority Dependency</strong></th>
<th><strong>Notes</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>&lt;None&gt;</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="manual-configuration-changes">Manual Configuration Changes</h3>
<table>
<colgroup>
<col style="width: 39%" />
<col style="width: 47%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Constant</strong></th>
<th><strong>Notes</strong></th>
<th><strong>SWC</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>&lt;None&gt;</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="integration">Integration</h1>
<h2 id="required-global-data-inputs">Required Global Data Inputs</h2>
<h2 id="required-global-data-outputs">Required Global Data Outputs</h2>
<h2 id="specific-include-path-present">Specific Include Path present</h2>
<p>The <strong>…StaMd/include</strong> patch needs to be added to the include search path of the CCS project. Typical setting: <strong>"${workspace_loc:/FORD_S550_P552/StaMd/include}"</strong></p>
<h1 id="runnable-scheduling">Runnable Scheduling </h1>
<p>This section specifies the required runnable scheduling.</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 53%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Init</strong></th>
<th><strong>Scheduling Requirements</strong></th>
<th><strong>Trigger</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>None</td>
<td>None</td>
<td>Init</td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col style="width: 36%" />
<col style="width: 45%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Runnable</strong></th>
<th><strong>Scheduling Requirements</strong></th>
<th><strong>Trigger</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td></td>
<td>10ms</td>
</tr>
</tbody>
</table>
<p><strong>.</strong></p>
<h1 id="memory-mapping">Memory Mapping</h1>
<h2 id="mapping">Mapping</h2>
<table>
<colgroup>
<col style="width: 66%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Memory Section</strong></th>
<th><strong>Contents</strong></th>
<th><strong>Notes</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>STAMD_START_SEC_VAR_SAVED_ZONEHGS_32</p>
<p>STAMD_START_SEC_VAR_SAVED_ZONEHGS_8</p></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>* Each …START_SEC… constant is terminated by a …STOP_SEC… constant as specified in the AUTOSAR Memory Mapping requirements.</p>
<h2 id="usage">Usage</h2>
<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 23%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Feature</strong></th>
<th><strong>RAM</strong></th>
<th><strong>ROM</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>&lt;Memmap usuage info&gt;</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Table 1: ARM Cortex R4 Memory Usage</p>
<h2 id="non-rte-nvm-blocks">Non RTE NvM Blocks</h2>
<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Block Name</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>&lt;None &gt;</strong></td>
</tr>
</tbody>
</table>
<p>Note : Size of the NVM block if configured in developer</p>
<h2 id="rte-nvm-blocks"> RTE NvM Blocks</h2>
<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Block Name</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>None</td>
</tr>
</tbody>
</table>
<p>Note : Size of the NVM block if configured in developer</p>
<h1 id="compiler-settings">Compiler Settings</h1>
<h2 id="preprocessor-macro"> Preprocessor MACRO</h2>
<p>&lt;Define all the preprocessor Macros needed and conditions when needed&gt;.</p>
<h2 id="optimization-settings">Optimization Settings</h2>
<p>&lt;Define Optimization levels that are needed and conditions when needed&gt;.</p>
<h2 class="unnumbered" id="section-1"></h2>
<h1 id="revision-control-log">Revision Control Log</h1>
<table>
<colgroup>
<col style="width: 7%" />
<col style="width: 71%" />
<col style="width: 12%" />
<col style="width: 8%" />
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Rev #</strong></td>
<td><strong>Change Description</strong></td>
<td><strong>Date</strong></td>
<td><strong>Author</strong></td>
</tr>
<tr class="even">
<td>1</td>
<td>Initial version</td>
<td>12-Dec-13</td>
<td>BDO</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Updated to FDD ES10B version 13 to address anomaly 5388. CR11347</td>
<td>07-Feb-14</td>
<td>BDO</td>
</tr>
<tr class="even">
<td>3</td>
<td>Anomaly 7307 - updates for consistency with FDD ES10B version 13 12602</td>
<td>28-Oct-14</td>
<td>BDO</td>
</tr>
</tbody>
</table>
